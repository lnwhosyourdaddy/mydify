<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>æ™ºèƒ½ç­”é¢˜ç³»ç»Ÿ</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/bootstrap-icons/1.8.1/font/bootstrap-icons.min.css">
    <style>
        .exam-card { border-radius: 15px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .option-item { transition: all 0.2s ease; cursor: pointer; }
        .option-item:hover { transform: translateY(-2px); background-color: #f8f9fa; }
        #timer {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            top: 1rem;
            z-index: 1000;
            background: rgba(255, 193, 7, 0.9);
            padding: 0.8rem 2rem;
            border-radius: 30px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 1.2rem;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.05); }
            100% { transform: translateX(-50%) scale(1); }
        }
        @media (max-width: 576px) {
            #timer {
                padding: 0.6rem 1.5rem;
                font-size: 1rem;
                top: 0.5rem;
            }
        }
        .correct { background: #d4edda !important; border-color: #c3e6cb !important; }
        .wrong { background: #f8d7da !important; border-color: #f5c6cb !important; }
        #wrongAnswers { 
            max-height: 400px; 
            overflow-y: auto;
            border-top: 1px solid #dee2e6;
            margin-top: 1.5rem;
            padding-top: 1rem;
        }
        .wrong-item {
            background: #fff5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .wrong-item div {
            margin-bottom: 0.5rem;
        }
        .wrong-item .fw-bold {
            font-size: 1.1rem;
            color: #dc3545;
        }
        .text-danger {
            color: #dc3545 !important;
        }
        .text-success {
            color: #198754 !important;
        }
        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .config-item {
            margin-bottom: 1.5rem;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container">
        <!-- é¦–é¡µ -->
        <div id="home" class="row justify-content-center mt-5">
            <div class="col-12 col-md-8 col-lg-6">
                <div class="card exam-card">
                    <div class="card-body p-4">
                        <h2 class="card-title text-center mb-4">ğŸ“š æ™ºèƒ½ç­”é¢˜ç³»ç»Ÿ</h2>
                        
                        <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
                        <div class="config-item">
                            <input type="file" id="excelFile" class="form-control" 
                                   accept=".xlsx,.xls" hidden
                                   onchange="handleFileSelect(event)">
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-primary" onclick="document.getElementById('excelFile').click()">
                                    <i class="bi bi-file-earmark-spreadsheet"></i> 
                                    <span id="uploadText">ä¸Šä¼ é¢˜åº“æ–‡ä»¶</span>
                                </button>
                                <button class="btn btn-success" onclick="parseExcel()" id="parseBtn" disabled>
                                    <span id="parseText">
                                        <i class="bi bi-gear"></i> è§£ææ–‡ä»¶
                                    </span>
                                </button>
                                <small class="text-muted text-center" id="fileStatus"></small>
                            </div>
                        </div>
                        <div class="config-item" id="domainSelection" style="display:none;">
                            <label class="form-label">é€‰æ‹©é¢†åŸŸ</label>
                            <select id="domain" class="form-select">
                                <option value="all" selected>å…¨éƒ¨é¢†åŸŸ</option>
                                <!-- åŠ¨æ€æ·»åŠ é¢†åŸŸé€‰é¡¹ -->
                            </select>
                        </div>

                        <!-- é¢˜ç›®æ•°é‡é…ç½® -->
                        <div class="config-item">
                            <label class="form-label">é¢˜ç›®æ•°é‡</label>
                            <select id="questionCount" class="form-select">
                                <option value="1">1é¢˜</option>
                                <option value="5">5é¢˜</option>
                                <option value="10" selected>10é¢˜</option>
                                <option value="20">20é¢˜</option>
                                <option value="50">50é¢˜</option>
                                <option value="100">100é¢˜</option>
                            </select>
                        </div>

                        <!-- æ–°å¢ï¼šç­”é¢˜æ—¶é—´é…ç½® -->
                        <div class="config-item">
                            <label class="form-label">æ¯é¢˜ç­”é¢˜æ—¶é—´</label>
                            <select id="answerTime" class="form-select">
                                <option value="30">30ç§’</option>
                                <option value="60" selected>1åˆ†é’Ÿ</option>
                                <option value="90">1åˆ†30ç§’</option>
                                <option value="120">2åˆ†é’Ÿ</option>
                                <option value="180">3åˆ†é’Ÿ</option>
                                <option value="300">5åˆ†é’Ÿ</option>
                            </select>
                            <small class="text-muted">æ¯é“é¢˜çš„ç­”é¢˜æ—¶é—´é™åˆ¶</small>
                        </div>

                        <div class="d-grid">
                            <button class="btn btn-primary btn-lg" onclick="startExam()" id="startBtn" disabled>
                                <i class="bi bi-patch-check"></i> å¼€å§‹ç­”é¢˜
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- è€ƒè¯•ç•Œé¢ -->
        <div id="examContainer" class="d-none">
            <div id="timer">
                <i class="bi bi-clock-history"></i>
                <span id="timeDisplay">60ç§’</span>
            </div>

            <div class="card exam-card mt-4">
                <div class="card-body p-3 p-md-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="badge bg-primary">å½“å‰è¿›åº¦</span>
                        <span id="progress">0/0</span>
                    </div>

                    <h4 class="question-text mb-4" id="questionText"></h4>

                    <div id="optionsContainer" class="list-group gap-2"></div>

                    <div class="d-grid gap-2 mt-4">
                        <div class="btn-group">
                            <button class="btn btn-secondary col-4" onclick="previousQuestion()" id="prevBtn" disabled>
                                <i class="bi bi-arrow-left"></i> ä¸Šä¸€é¢˜
                            </button>
                            <button class="btn btn-primary col-8" onclick="nextQuestion()" id="nextBtn">
                                ä¸‹ä¸€é¢˜ <i class="bi bi-arrow-right"></i>
                            </button>
                        </div>
                        <button class="btn btn-danger" onclick="submitExam()" id="submitBtn" style="display:none;">
                            <i class="bi bi-send"></i> æäº¤ç­”å·
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç»“æœé¡µ -->
        <div id="result" class="d-none">
            <div class="card exam-card mt-5">
                <div class="card-body p-4 text-center">
                    <h2 class="mb-3">ğŸ‰ ç­”é¢˜å®Œæˆï¼</h2>
                    <div class="display-4 text-success mb-4" id="accuracy">0%</div>
                    <div class="mb-3">
                        <span class="badge bg-info">
                            <i class="bi bi-stopwatch"></i> 
                            <span id="timeUsed">ç”¨æ—¶: 0ç§’</span>
                        </span>
                    </div>
                    
                    <div class="mt-4 text-start" id="wrongAnswers">
                        <h5 class="mb-3">ğŸ“ é”™é¢˜è§£æ</h5>
                        <div id="wrongList"></div>
                    </div>

                    <div class="d-grid gap-2 col-8 mx-auto mt-4">
                        <button class="btn btn-outline-primary" onclick="showHome()">
                            <i class="bi bi-house-door"></i> è¿”å›é¦–é¡µ
                        </button>
                        <button class="btn btn-primary" onclick="restartExam()">
                            <i class="bi bi-arrow-repeat"></i> é‡æ–°ç­”é¢˜
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>

    <script>
        // å…¨å±€çŠ¶æ€ç®¡ç†
        const AppState = {
            domains: [],
            selectedDomain: 'all',
            knowledgeBase: [],
            itemsByCategory: {},
            exam: {
                questions: [],
                currentIndex: 0,
                correctCount: 0,
                userAnswers: [],
                timerId: null,
                timeLeft: 60,
                totalTime: 0,
                timePerQuestion: 60,
                startTime: null
            },
            file: null
        };

        // æ–‡ä»¶é€‰æ‹©å¤„ç†
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            AppState.file = file;
            document.getElementById('parseBtn').disabled = false;
            document.getElementById('fileStatus').textContent = `å·²é€‰æ‹©æ–‡ä»¶ï¼š${file.name}`;
            document.getElementById('uploadText').textContent = "æ›´æ¢é¢˜åº“æ–‡ä»¶";
            // é‡ç½®é¢†åŸŸé€‰æ‹©æ¡†çŠ¶æ€
            document.getElementById('domainSelection').style.display = 'none';
            document.getElementById('domain').innerHTML = '<option value="all" selected>å…¨éƒ¨é¢†åŸŸ</option>';
        }

        // è§£æExcelæ–‡ä»¶
        function parseExcel() {
            const parseBtn = document.getElementById('parseBtn');
            const parseText = document.getElementById('parseText');
            // åœ¨ parseExcel() å‡½æ•°ä¸­æ·»åŠ ä»¥ä¸‹ä»£ç 
            const domainSet = new Set();
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            parseBtn.disabled = true;
            parseText.innerHTML = '<span class="loading-spinner"></span> è§£æä¸­...';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(sheet);

                    // æ„å»ºçŸ¥è¯†ç‚¹åº“å’Œåˆ†ç±»æ¡ç›®
                    const categoryMap = new Map();
                    AppState.knowledgeBase = rows.map(row => {
                        const domain = row['é¢†åŸŸ']?.toString() || 'æ— é¢†åŸŸ';
                        domainSet.add(domain);  // æ”¶é›†æ‰€æœ‰é¢†åŸŸ
                        const category = row['åˆ†ç±»å·']?.toString() || 'æœªåˆ†ç±»';
                        const answers = row['æ­£ç¡®ç­”æ¡ˆ']?.split('ã€‚').map(s => s.trim()) || ['æ— ç­”æ¡ˆ'];
                        
                        // æ”¶é›†åˆ†ç±»æ¡ç›®
                        if (!categoryMap.has(category)) {
                            categoryMap.set(category, new Set());
                        }
                        answers.forEach(answer => categoryMap.get(category).add(answer));
                        
                        return {
                            question: row['é—®é¢˜'] || 'æ— é¢˜ç›®',
                            answer: row['æ­£ç¡®ç­”æ¡ˆ']?.split('ã€‚').map(s => s.trim()) || ['æ— ç­”æ¡ˆ'],
                            category: row['åˆ†ç±»å·']?.toString() || 'æœªåˆ†ç±»',
                            domain: domain  // ç¡®ä¿domainå­—æ®µè¢«ä¿å­˜
                        };
                    });

                    // ä¿å­˜æ‰€æœ‰é¢†åŸŸåˆ°AppState
                    AppState.domains = Array.from(domainSet).sort();

                    // è½¬æ¢åˆ†ç±»æ•°æ®
                    AppState.itemsByCategory = {};
                    categoryMap.forEach((values, key) => {
                        AppState.itemsByCategory[key] = Array.from(values);
                    });

                    document.getElementById('startBtn').disabled = false;
                    parseText.innerHTML = '<i class="bi bi-gear"></i> è§£ææˆåŠŸ';
                    document.getElementById('domainSelection').style.display = 'block';
                    populateDomainOptions();
                    
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯3ç§’åæ¢å¤æŒ‰é’®çŠ¶æ€
                    setTimeout(() => {
                        parseText.innerHTML = '<i class="bi bi-gear"></i> è§£ææ–‡ä»¶';
                        parseBtn.disabled = false;
                    }, 3000);
                    
                    alert(`é¢˜åº“åŠ è½½æˆåŠŸï¼\né¢˜ç›®æ•°ï¼š${AppState.knowledgeBase.length}\né¢†åŸŸæ•°ï¼š${Object.keys(AppState.domains).length}\nåˆ†ç±»æ•°ï¼š${Object.keys(AppState.itemsByCategory).length}`);
                } catch (error) {
                    parseText.innerHTML = '<i class="bi bi-gear"></i> è§£ææ–‡ä»¶';
                    parseBtn.disabled = false;
                    alert("æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼");
                    console.error(error);
                }
            };
            reader.onerror = function() {
                parseText.innerHTML = '<i class="bi bi-gear"></i> è§£ææ–‡ä»¶';
                parseBtn.disabled = false;
                alert("æ–‡ä»¶è¯»å–å¤±è´¥");
            };
            reader.readAsArrayBuffer(AppState.file);
        }

        //åŠ¨æ€ç”Ÿæˆé¢†åŸŸé€‰é¡¹çš„å‡½æ•°
        function populateDomainOptions() {
            const domainSelect = document.getElementById('domain');
            domainSelect.innerHTML = '<option value="all" selected>å…¨éƒ¨é¢†åŸŸ</option>';
            
            AppState.domains.forEach(domain => {
                const option = document.createElement('option');
                option.value = domain;
                option.textContent = domain;
                domainSelect.appendChild(option);
            });
        }
        // å¼€å§‹è€ƒè¯•
        function startExam() {
            // è·å–é€‰ä¸­çš„é¢†åŸŸ
            AppState.selectedDomain = document.getElementById('domain').value;
            const total = parseInt(document.getElementById('questionCount').value);
            if (total > AppState.knowledgeBase.length) {
                alert(`é¢˜åº“ä¸è¶³ï¼Œå½“å‰å…±æœ‰${AppState.knowledgeBase.length}é¢˜`);
                return;
            }

            // è·å–ç”¨æˆ·é…ç½®çš„æ—¶é—´
            const timePerQuestion = parseInt(document.getElementById('answerTime').value);
            
            // åˆå§‹åŒ–è€ƒè¯•çŠ¶æ€
            AppState.exam = {
                questions: getRandomQuestions(total),
                currentIndex: 0,
                correctCount: 0,
                userAnswers: Array(total).fill(null),
                timerId: null,
                timeLeft: timePerQuestion,
                totalTime: 0,
                timePerQuestion: timePerQuestion,
                startTime: new Date()
            };

            showScreen('examContainer');
            showQuestion();
            startTimer();
        }

        // è·å–éšæœºé¢˜ç›®
        function getRandomQuestions(count) {
            // æ ¹æ®é€‰æ‹©çš„é¢†åŸŸç­›é€‰é¢˜ç›®
            let pool = AppState.knowledgeBase;
            if (AppState.selectedDomain !== 'all') {
                pool = pool.filter(q => q.domain === AppState.selectedDomain);
            }
            if (pool.length < count) {
                alert(`è¯¥é¢†åŸŸåªæœ‰${pool.length}é¢˜ï¼Œä¸è¶³${count}é¢˜`);
                return [];
            }   
            // ä»ç­›é€‰åçš„é¢˜ç›®ä¸­éšæœºé€‰æ‹©
            //const shuffled = [...AppState.knowledgeBase].sort(() => 0.5 - Math.random());
            const shuffled = [...pool].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count).map(q => ({
                ...q,
                options: generateOptions(q),
                correctAnswer: q.answer.join("ã€")
            }));
        }

        // æ˜¾ç¤ºé¢˜ç›®
        function showQuestion() {
            const question = AppState.exam.questions[AppState.exam.currentIndex];
            document.getElementById('questionText').textContent = question.question;
            
            const optionsHTML = question.options.map((opt, i) => `
                <label class="list-group-item option-item rounded-pill">
                    <input type="radio" name="answer" class="form-check-input me-2"
                           value="${i}" data-is-correct="${opt.isCorrect}"
                           ${getAnswerState(i)}>
                    ${String.fromCharCode(65 + i)}. ${opt.text}
                </label>
            `).join('');
            
            document.getElementById('optionsContainer').innerHTML = optionsHTML;
            updateProgress();
            updateButtonState();
            
            // é‡ç½®å½“å‰é¢˜ç›®çš„è®¡æ—¶å™¨
            AppState.exam.timeLeft = AppState.exam.timePerQuestion;
            updateTimeDisplay();
        }

        // ç”Ÿæˆæ™ºèƒ½é€‰é¡¹
        function generateOptions(question) {
            // 1. å‡†å¤‡åŸºç¡€æ•°æ®
            const correctAnswers = question.answer.map(a => a.trim()).filter(a => a);
            const correctText = correctAnswers.join("ã€");
            const allItems = AppState.itemsByCategory[question.category] || [];
            
            // 2. æ ¹æ®ç­”æ¡ˆæ•°é‡ç¡®å®šé€‰é¡¹ç­–ç•¥
            const answerCount = correctAnswers.length;
            let optionCount = Math.min(4, Math.max(4, answerCount + 1)); // è‡³å°‘4ä¸ªï¼Œæœ€å¤š4ä¸ªé€‰é¡¹
            
            // 3. ç”Ÿæˆå¹²æ‰°é¡¹ç­–ç•¥
            const generateDistractors = () => {
                const distractors = new Set();
                const maxAttempts = 100;
                let attempts = 0;
                
                // ç­–ç•¥1ï¼šå®Œå…¨éšæœºç»„åˆ
                while (distractors.size < optionCount - 1 && attempts < maxAttempts) {
                    attempts++;
                    const randomCombo = [...allItems]
                        .sort(() => 0.5 - Math.random())
                        .slice(0, answerCount)
                        .sort()
                        .join("ã€");
                    
                    if (randomCombo && randomCombo !== correctText) {
                        distractors.add(randomCombo);
                    }
                }
                
                // ç­–ç•¥2ï¼šéƒ¨åˆ†æ­£ç¡®ç­”æ¡ˆ+å¹²æ‰°é¡¹ï¼ˆé’ˆå¯¹å¤šé€‰æƒ…å†µï¼‰
                if (answerCount > 1 && distractors.size < optionCount - 1) {
                    attempts = 0;
                    while (distractors.size < optionCount - 1 && attempts < maxAttempts) {
                        attempts++;
                        // æ›¿æ¢éƒ¨åˆ†æ­£ç¡®ç­”æ¡ˆ
                        const replaceCount = Math.max(1, Math.floor(answerCount / 2));
                        const partialCorrect = [...correctAnswers]
                            .sort(() => 0.5 - Math.random())
                            .slice(0, answerCount - replaceCount);
                        
                        const randomItems = [...allItems]
                            .sort(() => 0.5 - Math.random())
                            .slice(0, replaceCount);
                        
                        const mixedCombo = [...partialCorrect, ...randomItems]
                            .sort()
                            .join("ã€");
                        
                        if (mixedCombo && mixedCombo !== correctText) {
                            distractors.add(mixedCombo);
                        }
                    }
                }
                
                return Array.from(distractors);
            };
            
            // 4. ç”Ÿæˆæœ€ç»ˆé€‰é¡¹
            const distractors = generateDistractors();
            const allOptions = [correctText, ...distractors.slice(0, optionCount - 1)];
            
            // 5. ç¡®ä¿é€‰é¡¹æ•°é‡è¶³å¤Ÿ
            while (allOptions.length < optionCount) {
                allOptions.push(`å¹²æ‰°é€‰é¡¹${allOptions.length + 1}`);
            }
            
            // 6. è¿”å›å¤„ç†åçš„é€‰é¡¹
            return shuffle(allOptions.map(text => ({
                text: cleanText(text),
                isCorrect: cleanText(text) === cleanText(correctText)
            })));
        }

        // æ¸…ç†æ–‡æœ¬çš„è¾…åŠ©å‡½æ•°
        function cleanText(text) {
            return text.replace(/^ã€+|ã€+$/g, '')
                    .replace(/ã€{2,}/g, 'ã€');
        }

        // ç­”æ¡ˆé€‰æ‹©å¤„ç†
        function selectAnswer(index, isCorrect) {
            const currentIndex = AppState.exam.currentIndex;
            
            // å¦‚æœä¹‹å‰å·²ç»å›ç­”è¿‡æ­¤é¢˜ä¸”ç­”å¯¹äº†ï¼Œç°åœ¨è¦ä¿®æ”¹ç­”æ¡ˆï¼Œéœ€è¦å‡å°‘æ­£ç¡®è®¡æ•°
            if (AppState.exam.userAnswers[currentIndex]?.isCorrect) {
                AppState.exam.correctCount--;
            }
            
            AppState.exam.userAnswers[currentIndex] = { index, isCorrect };
            
            // å¦‚æœæ–°ç­”æ¡ˆæ˜¯æ­£ç¡®ç­”æ¡ˆï¼Œå¢åŠ æ­£ç¡®è®¡æ•°
            if (isCorrect) {
                AppState.exam.correctCount++;
            }
            
            highlightAnswers();
            updateButtonState();
        }

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        function updateButtonState() {
            const isLast = AppState.exam.currentIndex === AppState.exam.questions.length - 1;
            document.getElementById('prevBtn').disabled = AppState.exam.currentIndex === 0;
            document.getElementById('nextBtn').disabled = isLast;
            document.getElementById('submitBtn').style.display = isLast ? 'block' : 'none';
        }

        // é«˜äº®ç­”æ¡ˆ
        function highlightAnswers() {
            document.querySelectorAll('#optionsContainer label').forEach(label => {
                const input = label.querySelector('input');
                label.classList.remove('correct', 'wrong');
                
                if (input.checked) {
                    label.classList.add(input.dataset.isCorrect === 'true' ? 'correct' : 'wrong');
                }
            });
        }

        // éšæœºæ‰“ä¹±æ•°ç»„
        function shuffle(arr) {
            const result = [...arr];
            for (let i = result.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [result[i], result[j]] = [result[j], result[i]];
            }
            return result;
        }

        // è·å–ç­”æ¡ˆçŠ¶æ€
        function getAnswerState(index) {
            const userAnswer = AppState.exam.userAnswers[AppState.exam.currentIndex];
            return userAnswer?.index === index ? 'checked' : '';
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress() {
            document.getElementById('progress').textContent = 
                `${AppState.exam.currentIndex + 1}/${AppState.exam.questions.length}`;
        }

        // æ›´æ–°æ—¶é—´æ˜¾ç¤º
        function updateTimeDisplay() {
            let displayText;
            if (AppState.exam.timeLeft >= 60) {
                const minutes = Math.floor(AppState.exam.timeLeft / 60);
                const seconds = AppState.exam.timeLeft % 60;
                displayText = `${minutes}åˆ†${seconds}ç§’`;
            } else {
                displayText = `${AppState.exam.timeLeft}ç§’`;
            }
            document.getElementById('timeDisplay').textContent = displayText;
        }

        // è®¡æ—¶å™¨
        function startTimer() {
            clearInterval(AppState.exam.timerId);
            updateTimeDisplay();
            
            AppState.exam.timerId = setInterval(() => {
                AppState.exam.timeLeft--;
                updateTimeDisplay();
                
                if (AppState.exam.timeLeft <= 0) {
                    // æ—¶é—´åˆ°è‡ªåŠ¨è¿›å…¥ä¸‹ä¸€é¢˜æˆ–æäº¤
                    if (AppState.exam.currentIndex < AppState.exam.questions.length - 1) {
                        nextQuestion();
                    } else {
                        submitExam();
                    }
                }
            }, 1000);
        }

        // æäº¤è€ƒè¯•
        function submitExam() {
            clearInterval(AppState.exam.timerId);
            
            // è®¡ç®—æ€»ç”¨æ—¶
            const endTime = new Date();
            const totalSeconds = Math.floor((endTime - AppState.exam.startTime) / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            let timeUsedText = '';
            
            if (minutes > 0) {
                timeUsedText = `${minutes}åˆ†${seconds}ç§’`;
            } else {
                timeUsedText = `${seconds}ç§’`;
            }
            
            document.getElementById('timeUsed').textContent = `ç”¨æ—¶: ${timeUsedText}`;
            
            // è®¡ç®—å‡†ç¡®ç‡
            const accuracy = (AppState.exam.correctCount / AppState.exam.questions.length * 100).toFixed(1);
            document.getElementById('accuracy').textContent = `${accuracy}%`;
            
            // æ”¶é›†é”™é¢˜
            const wrongAnswers = [];
            AppState.exam.questions.forEach((question, index) => {
                const userAnswer = AppState.exam.userAnswers[index];
                if (!userAnswer || !userAnswer.isCorrect) {
                    wrongAnswers.push({
                        question: question.question,
                        correctAnswer: question.correctAnswer,
                        userAnswer: userAnswer ? 
                            question.options[userAnswer.index].text : 'æœªä½œç­”',
                        index: wrongAnswers.length + 1
                    });
                }
            });
            
            // æ¸²æŸ“é”™é¢˜åˆ—è¡¨
            const wrongList = document.getElementById('wrongList');
            wrongList.innerHTML = wrongAnswers.map(item => `
                <div class="wrong-item">
                    <div class="fw-bold mb-2">âŒ é”™é¢˜ ${item.index}</div>
                    <div class="mb-2">${item.question}</div>
                    <div class="text-danger">æ‚¨çš„ç­”æ¡ˆï¼š${item.userAnswer}</div>
                    <div class="text-success">æ­£ç¡®ç­”æ¡ˆï¼š${item.correctAnswer}</div>
                </div>
            `).join('');
            
            showScreen('result');
        }

        // æ˜¾ç¤ºé¡µé¢
        function showScreen(screenId) {
            ['home', 'examContainer', 'result'].forEach(id => {
                document.getElementById(id).classList.add('d-none');
            });
            document.getElementById(screenId).classList.remove('d-none');
        }

        // è¿”å›é¦–é¡µ
        function showHome() {
            showScreen('home');
        }

        // é‡æ–°è€ƒè¯•
        function restartExam() {
            startExam();
        }

        // ä¸Šä¸€é¢˜
        function previousQuestion() {
            if (AppState.exam.currentIndex > 0) {
                AppState.exam.currentIndex--;
                showQuestion();
            }
        }

        // ä¸‹ä¸€é¢˜
        function nextQuestion() {
            if (AppState.exam.currentIndex < AppState.exam.questions.length - 1) {
                AppState.exam.currentIndex++;
                showQuestion();
            }
        }

        // ä¸ºé€‰é¡¹æ·»åŠ ç‚¹å‡»äº‹ä»¶å§”æ‰˜
        document.getElementById('optionsContainer').addEventListener('click', function(e) {
            const label = e.target.closest('.option-item');
            if (!label) return;
            
            const input = label.querySelector('input');
            if (!input) return;
            
            input.checked = true;
            const index = parseInt(input.value);
            const isCorrect = input.dataset.isCorrect === 'true';
            selectAnswer(index, isCorrect);
        });
    </script>
</body>
</html>
